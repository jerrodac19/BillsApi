<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial Projection</title>

    <script src="https://cdn.jsdelivr.net/npm/luxon/build/global/luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon/dist/chartjs-adapter-luxon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-trendline/dist/chartjs-plugin-trendline.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>

    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            font-family: Arial, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            flex-direction: column;
        }

        .chart-container {
            --point-size: 4;
            position: relative;
            width: 90vw;
            flex: 1;
            min-height: 300px;
            max-height: 80vh;
            margin: 20px auto 10px auto;
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .info-panel {
            width: 90vw;
            margin-top: 10px;
            margin-bottom: 20px;
            background-color: #1e1e1e;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

            .info-panel p {
                margin: 5px 0;
                font-size: 1.1em;
            }

        @media (max-width: 768px) {
            .chart-container {
                --point-size: 1.0;
                width: 95vw;
                min-height: 280px;
                margin: 10px auto 5px auto;
                padding: 12px;
            }

            .info-panel {
                width: 95vw;
                margin-top: 5px;
                margin-bottom: 10px;
                padding: 12px;
            }
        }

        @media (max-width: 480px) {
            .chart-container,
            .info-panel {
                box-sizing: border-box;
            }

            .chart-container {
                --point-size: 0.7;
                width: 98vw;
                height: 85vw;
                flex: none;
                min-height: auto;
                padding: 10px;
                margin: 5px auto;
            }

            .info-panel {
                width: 98vw;
                margin: 5px auto;
                padding: 10px;
            }

                .info-panel p {
                    font-size: 1em;
                }
        }
    </style>
</head>
<body>
    <div id="info-panel" class="info-panel">
        <p>Loading financial data and projections...</p>
    </div>
    <div class="chart-container">
        <canvas id="myFinancialChart"></canvas>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            fetch('/api/balancemonitors/analytics?Weights=True')
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error("Error from backend:", data.error);
                        document.getElementById('info-panel').innerHTML = `<p style="color: red;">Error loading financial data: ${data.error}</p>`;
                        return;
                    }

                    const pointSize = getComputedStyle(document.querySelector('.chart-container')).getPropertyValue('--point-size');
                    const startDate = new Date(data.startTimeUnix * 1000);

                    const formatDataForChart = (arr) => {
                        return arr.map(point => ({
                            x: new Date(startDate.getTime() + point[0] * 24 * 60 * 60 * 1000),
                            y: point[1]
                        }));
                    };

                    const historicalChartData = formatDataForChart(data.historicalData);
                    const trendlineChartData = formatDataForChart(data.trendline);
                    const lowerPIChartData = formatDataForChart(data.lowerPredictionInterval);
                    const upperPIChartData = formatDataForChart(data.upperPredictionInterval);

                    const minXDate = historicalChartData[0].x;
                    let maxXDate = trendlineChartData[trendlineChartData.length - 1].x;
                    const totalRangeMs = maxXDate.getTime() - minXDate.getTime();
                    const bufferMs = totalRangeMs * 0.05;
                    maxXDate = new Date(maxXDate.getTime() + bufferMs);

                    const maxAmount = historicalChartData[0].y;
                    let minAmount = historicalChartData[historicalChartData.length - 1].y;
                    const buffferAmount = (maxAmount - minAmount) * 0.1;
                    minAmount = Math.floor((minAmount - buffferAmount) / 1000) * 1000;

                    let earliestRunOutDate = null;
                    let latestRunOutDate = null;

                    if (data.earliestRunOutDateX && data.earliestRunOutDateX !== Infinity) {
                        earliestRunOutDate = new Date(startDate.getTime() + data.earliestRunOutDateX * 24 * 60 * 60 * 1000);
                    }

                    if (data.latestRunOutDateX && data.latestRunOutDateX !== Infinity) {
                        latestRunOutDate = new Date(startDate.getTime() + data.latestRunOutDateX * 24 * 60 * 60 * 1000);
                    }

                    const earliestDateDisplay = earliestRunOutDate ? earliestRunOutDate.toLocaleDateString() : 'N/A (Money may not run out within projected range)';
                    const latestDateDisplay = latestRunOutDate && latestRunOutDate !== Infinity ? latestRunOutDate.toLocaleDateString() : 'N/A (Money may not run out within projected range)';

                    let trendlineinformation = [];
                    trendlineinformation.push(`Money estimated to last until:`);
                    trendlineinformation.push(`Earliest Date: ${earliestDateDisplay}`);
                    trendlineinformation.push(`Latest Date: ${latestDateDisplay}`);
                    const infoPanel = document.getElementById('info-panel');
                    infoPanel.innerHTML = trendlineinformation.map(line => `<p>${line}</p>`).join('');

                    const ctx = document.getElementById('myFinancialChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [
                                {
                                    label: 'Historical Balance',
                                    data: historicalChartData,
                                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    type: 'scatter',
                                    showLine: false,
                                    pointRadius: pointSize
                                },
                                {
                                    label: 'Trendline',
                                    data: trendlineChartData,
                                    borderColor: 'red',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false,
                                    pointRadius: 0
                                },
                                {
                                    label: 'Prediction Interval (Upper)',
                                    data: upperPIChartData,
                                    borderColor: 'rgba(0, 200, 0, 0.5)',
                                    borderWidth: 1,
                                    fill: false,
                                    pointRadius: 0
                                },
                                {
                                    label: 'Prediction Interval (Lower)',
                                    data: lowerPIChartData,
                                    borderColor: 'rgba(0, 200, 0, 0.5)',
                                    borderWidth: 1,
                                    fill: '-1',
                                    backgroundColor: 'rgba(0, 200, 0, 0.1)',
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        unit: 'day',
                                        tooltipFormat: 'MMM D, YYYY'
                                    },
                                    title: {
                                        display: true,
                                        text: 'Date'
                                    },
                                    min: minXDate,
                                    max: latestRunOutDate
                                },
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Money Balance ($)'
                                    },
                                    min: 0
                                }
                            },
                            plugins: {
                                tooltip: {
                                    callbacks: {
                                        title: function (context) {
                                            return new Date(context[0].parsed.x).toLocaleDateString();
                                        },
                                        label: function (context) {
                                            return context.dataset.label + ': $' + context.parsed.y.toFixed(2);
                                        }
                                    }
                                },
                                annotation: {}
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('There was a problem with the fetch operation:', error);
                    document.getElementById('info-panel').innerHTML = `<p style="color: red;">Could not load chart data. Check the server console.</p>`;
                });
        });
    </script>
</body>
</html>